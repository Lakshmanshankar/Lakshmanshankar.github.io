---
import Layout from "@/layouts/Layout.astro";
import { render } from "astro:content";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import Toc from "@/components/toc.astro";
import BackToTop from "@/components/ui/BackToTop.astro";
import BackToPrev from "@/components/ui/BackToPrev.astro";
import { readingTime } from "@/lib/utils";
import FormattedDate from "@/components/ui/FormattedDate.astro";
import { Schema } from "astro-seo-schema";

import { SITE } from "@/consts";
export async function getStaticPaths() {
    const allPosts = await getCollection("blog")
    const posts = allPosts.filter((item)=> item.data?.draft !== true);
    return posts.map((post: { id: any }) => ({
        params: { slug: post.id },
        props: { post },
    }));
}
interface Props {
    post: CollectionEntry<"blog">;
}
const { post } = Astro.props;
const entry = await getEntry("blog", post.id);

if (!entry) {
    return new Response("Not Found", {
        status: 404,
        statusText: "Not Found",
    });
}
const { Content, headings } = await render(entry);
const url = SITE + Astro.url.pathname;
---

<Layout title={entry.data.title} description={entry.data.description}>
    <head>
        <Schema
            item={{
                "@context": "https://schema.org",
                "@type": "BlogPosting",
                mainEntityOfPage: {
                    "@type": "WebPage",
                    "@id": `${import.meta.env.SITE}/blog/${post.id}`,
                },
                headline: entry.data.title,
                description: entry.data.description,
                datePublished: entry.data.date.toISOString(),
                dateModified: entry.data.date.toISOString(),
                author: {
                    "@type": "Person",
                    name: "Lakshmanshankar",
                },
                url: url,
            }}
        />
    </head>

    <Toc headings={headings} />
    <article>
        <h1 class="mt-10 text-center">{entry.data.title}</h1>
        <div class="flex gap-2 text-sm justify-center items-center">
            <!-- <BackToPrev href="/blog">Back to Blog</BackToPrev> -->
            <div class="my-2 text-sm">
                <FormattedDate date={entry.data.date} includeYear />
                <span class="text-black dark:text-amber-500">â€¢</span>
                <span>{entry.body && readingTime(entry.body)}</span>
            </div>
        </div>
        {
            entry.data.image && (
                <img
                    src={entry.data.image}
                    alt={entry.data.title}
                    class="w-full h-auto rounded-md"
                />
            )
        }
        
        <Content />
        <BackToTop />
    </article>
</Layout>

<script>
    function throttle(func: () => void, delay: number) {
        let timeoutId: any;
        let lastExecTime = 0;

        return () => {
            const now = Date.now();

            if (now - lastExecTime > delay) {
                func();
                lastExecTime = now;
            } else {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(
                    () => {
                        func();
                        lastExecTime = Date.now();
                    },
                    delay - (now - lastExecTime),
                );
            }
        };
    }

    function highlightTocActiveItem() {
        const headers = document.querySelectorAll("h1, h2, h3");
        const tocLinks = document.querySelectorAll(".toc-link");

        const activeHeader = Array.from(headers).find((header) => {
            const rect = header.getBoundingClientRect();
            return rect.top >= 0 && rect.top <= 400;
        });

        if (!activeHeader) return;
        tocLinks.forEach((link) => {
            const isActive =
                link instanceof HTMLAnchorElement && link.dataset.targetId === activeHeader.id;

            link.classList.toggle("toc-active", isActive);
            link.setAttribute("data-toc-status", isActive ? "active" : "");

            if (isActive && window.innerWidth > 1200) {
                link.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
        });
    }

    const throttledHighlight = throttle(highlightTocActiveItem, 200);
    let isInitialRender = false;
    function setupTocScroll() {
        window.removeEventListener("scroll", throttledHighlight);
        window.addEventListener("scroll", throttledHighlight);
        highlightTocActiveItem();
    }

    // Initialize
    document.addEventListener("astro:after-swap", setupTocScroll);
    document.addEventListener("DOMContentLoaded", setupTocScroll);
    setupTocScroll();
</script>

<script>
    function addCopyLinkToHeadings() {
        const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]') as NodeListOf<HTMLHeadingElement>;
        
        headings.forEach((heading) => {
            if (heading.querySelector('.heading-link-icon')) return;
            
            const headingId = heading.getAttribute('id');
            if (!headingId) return;
            
            heading.style.position = 'relative';
            heading.style.cursor = 'pointer';
            
            // Create link icon
            const linkIcon = document.createElement('span');
            linkIcon.className = 'heading-link-icon';
            linkIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
            `;
            linkIcon.style.cssText = `
                display: inline-block;
                opacity: 0;
                margin-left: 0.5rem;
                transition: opacity 0.2s ease;
                vertical-align: middle;
                color: currentColor;
            `;
            
            // Show/hide on hover
            heading.addEventListener('mouseenter', () => {
                linkIcon.style.opacity = '0.6';
            });
            
            heading.addEventListener('mouseleave', () => {
                linkIcon.style.opacity = '0';
            });
            
            linkIcon.addEventListener('mouseenter', () => {
                linkIcon.style.opacity = '1';
            });
            
            // Copy link on click
            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}#${headingId}`;
                navigator.clipboard.writeText(url).then(() => {
                    // Scroll to heading with offset
                    const elementPosition = heading.getBoundingClientRect().top;
                    const offsetPosition = window.pageYOffset + elementPosition - 30;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                    
                    // Show copied feedback
                    const originalHTML = linkIcon.innerHTML;
                    linkIcon.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    `;
                    linkIcon.style.opacity = '1';
                    
                    setTimeout(() => {
                        linkIcon.innerHTML = originalHTML;
                        linkIcon.style.opacity = '0.6';
                    }, 1500);
                });
            };
            
            heading.addEventListener('click', copyLink);
            linkIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                copyLink();
            });
            
            heading.appendChild(linkIcon);
        });
    }
    
    document.addEventListener('astro:page-load', addCopyLinkToHeadings);
    document.addEventListener('DOMContentLoaded', addCopyLinkToHeadings);
    addCopyLinkToHeadings();
</script>
